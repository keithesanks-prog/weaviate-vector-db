<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Services Experience Analytics - Query Interface</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
        }
        .card {
            background-color: #2d2d2d;
            border: 1px solid #3a3a3a;
        }
        .result-card {
            transition: all 0.2s ease;
            background-color: #2d2d2d;
            border: 1px solid #3a3a3a;
            width: 100%;
            box-sizing: border-box;
        }
        .result-card:hover {
            border-color: #3b82f6;
            background-color: #333333;
        }
        #results {
            overflow-y: auto;
            max-height: none;
            width: 100%;
            box-sizing: border-box;
        }
        #results.empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #results.has-content {
            display: block;
        }
        #results > * {
            width: 100%;
            box-sizing: border-box;
        }
        .input-field {
            background-color: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #e5e5e5;
        }
        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-primary:disabled {
            background-color: #1e3a5f;
            opacity: 0.6;
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center py-6 mb-8 card p-6">
            <h1 class="text-3xl font-extrabold text-blue-400 mb-2">Social Services Experience Analytics Platform</h1>
            <p class="text-gray-400 mt-2">Semantic Search & Multi-Dimensional Filtering</p>
            <div id="status" class="mt-4 text-sm">
                <span id="connectionStatus" class="text-gray-400">Connecting to database...</span>
                <span id="dataStatus" class="ml-4"></span>
            </div>
        </header>

        <div class="card p-6 mb-10">
            <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-600 pb-2">Query Builder</h2>
            
            <!-- Semantic Search Input -->
            <div class="mb-6">
                <label for="queryInput" class="block text-sm font-medium text-gray-300 mb-1">
                    1. Abstract Concept Query (Semantic Search)
                </label>
                <input 
                    type="text" 
                    id="queryInput" 
                    value="" 
                    placeholder="e.g., hope and light, prayer and strength, community garden"
                    class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition"
                    onkeypress="if(event.key === 'Enter') handleSearch()"
                >
                <div class="mt-2 text-sm text-gray-400">
                    <strong>Example queries that work:</strong> 
                    <span class="cursor-pointer text-blue-400 hover:text-blue-300 hover:underline" onclick="document.getElementById('queryInput').value='hope and light'">hope and light</span> | 
                    <span class="cursor-pointer text-blue-400 hover:text-blue-300 hover:underline" onclick="document.getElementById('queryInput').value='prayer and strength'">prayer and strength</span> | 
                    <span class="cursor-pointer text-blue-400 hover:text-blue-300 hover:underline" onclick="document.getElementById('queryInput').value='community garden'">community garden</span> |
                    <span class="cursor-pointer text-blue-400 hover:text-blue-300 hover:underline" onclick="document.getElementById('queryInput').value='burnt plastic leaky pipe'">burnt plastic</span> |
                    <span class="cursor-pointer text-blue-400 hover:text-blue-300 hover:underline" onclick="document.getElementById('queryInput').value='homework candlelight'">homework candlelight</span> |
                    <span class="cursor-pointer text-blue-400 hover:text-blue-300 hover:underline" onclick="document.getElementById('queryInput').value='empty refrigerator'">empty refrigerator</span>
                </div>
            </div>

            <!-- Negative Filtering (Conceptual Exclusion) -->
            <div class="mb-6">
                <label for="excludeInput" class="block text-sm font-medium text-gray-300 mb-1">
                    Exclude Concepts (Optional - Negative Filtering)
                </label>
                <input 
                    type="text" 
                    id="excludeInput" 
                    value="" 
                    placeholder="e.g., Instrumental Support, Spiritual Resilience"
                    class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition"
                >
                <p class="mt-1 text-xs text-gray-500">Find experiences related to your query but exclude those matching this concept</p>
            </div>

            <!-- Filter Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filterReligiosity" class="block text-sm font-medium text-gray-300 mb-1">
                        2. Filter by Religious Participation
                    </label>
                    <select id="filterReligiosity" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="High (Weekly)">High (Weekly)</option>
                        <option value="Low (Monthly)">Low (Monthly)</option>
                        <option value="None">None</option>
                    </select>
                </div>
                <div>
                    <label for="filterAnxiety" class="block text-sm font-medium text-gray-300 mb-1">
                        3. Filter by Anxiety Level (Survey)
                    </label>
                    <select id="filterAnxiety" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="high">High Anxiety (4-5)</option>
                        <option value="low">Low Anxiety (1-2)</option>
                    </select>
                </div>
                <div>
                    <label for="filterAnxietyMin" class="block text-sm font-medium text-gray-300 mb-1">
                        Anxiety Range: Min (1-5)
                    </label>
                    <input type="number" id="filterAnxietyMin" min="1" max="5" placeholder="Min" 
                           class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label for="filterAnxietyMax" class="block text-sm font-medium text-gray-300 mb-1">
                        Anxiety Range: Max (1-5)
                    </label>
                    <input type="number" id="filterAnxietyMax" min="1" max="5" placeholder="Max" 
                           class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label for="filterProgram" class="block text-sm font-medium text-gray-300 mb-1">
                        Program Enrollment
                    </label>
                    <select id="filterProgram" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="SNAP">SNAP</option>
                        <option value="Medicaid">Medicaid</option>
                        <option value="TANF">TANF</option>
                        <option value="WIC">WIC</option>
                        <option value="Housing Voucher">Housing Voucher</option>
                        <option value="None">None</option>
                    </select>
                </div>
                <div>
                    <label for="filterEnrollmentStatus" class="block text-sm font-medium text-gray-300 mb-1">
                        Enrollment Status Change (Last 6 Mos)
                    </label>
                    <select id="filterEnrollmentStatus" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="Enrolled">Enrolled</option>
                        <option value="Denied">Denied</option>
                        <option value="Re-applied">Re-applied</option>
                        <option value="Disenrolled">Disenrolled</option>
                        <option value="None">None</option>
                    </select>
                </div>
                <div>
                    <label for="filterUrbanRural" class="block text-sm font-medium text-gray-300 mb-1">
                        Geographic Designation
                    </label>
                    <select id="filterUrbanRural" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="Urban">Urban</option>
                        <option value="Suburban">Suburban</option>
                        <option value="Rural">Rural</option>
                    </select>
                </div>
                <div>
                    <label for="filterTimeOfDay" class="block text-sm font-medium text-gray-300 mb-1">
                        Time of Day
                    </label>
                    <select id="filterTimeOfDay" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="Morning">Morning</option>
                        <option value="Afternoon">Afternoon</option>
                        <option value="Evening">Evening</option>
                        <option value="Night">Night</option>
                    </select>
                </div>
                <div>
                    <label for="filterLanguage" class="block text-sm font-medium text-gray-300 mb-1">
                        Primary Language
                    </label>
                    <select id="filterLanguage" class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                        <option value="ALL">ALL (No Filter)</option>
                        <option value="English">English</option>
                        <option value="Spanish">Spanish</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="filterMovesMin" class="block text-sm font-medium text-gray-300 mb-1">
                        Residential Moves: Min (Last 12 Mos)
                    </label>
                    <input type="number" id="filterMovesMin" min="0" placeholder="Min" 
                           class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label for="filterMovesMax" class="block text-sm font-medium text-gray-300 mb-1">
                        Residential Moves: Max (Last 12 Mos)
                    </label>
                    <input type="number" id="filterMovesMax" min="0" placeholder="Max" 
                           class="input-field w-full p-3 focus:ring-2 focus:ring-blue-500 transition">
                </div>
            </div>

            <div class="mb-4">
                <label class="flex items-center text-sm text-gray-300 cursor-pointer">
                    <input type="checkbox" id="includeNLM" class="mr-2 w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                    <span>Include NLM Health Information (MedlinePlus & PubMed)</span>
                </label>
                <p class="mt-1 text-xs text-gray-500 ml-6">Enrich results with relevant health information from the National Library of Medicine</p>
            </div>

            <div class="mb-4">
                <label class="flex items-center text-sm text-gray-300 cursor-pointer">
                    <input type="checkbox" id="includeSAMHSA" class="mr-2 w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                    <span>Include SAMHSA Mental Health Prevalence Data</span>
                </label>
                <p class="mt-1 text-xs text-gray-500 ml-6">Compare search results with official SAMHSA state-level mental health prevalence rates (NSDUH data)</p>
                <div id="samhsaMetricSelect" class="mt-2 ml-6" style="display: none;">
                    <label class="block text-xs text-gray-400 mb-1">SAMHSA Metric:</label>
                    <select id="samhsaMetric" class="input-field w-full md:w-48 p-2 text-sm">
                        <option value="SMI">Serious Mental Illness (SMI)</option>
                        <option value="AMI">Any Mental Illness (AMI)</option>
                    </select>
                </div>
            </div>

            <div class="flex items-end">
                <button 
                    id="searchButton" 
                    onclick="handleSearch()" 
                    class="btn-primary w-full p-3 font-semibold transition shadow-md focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50"
                >
                    Search Experiences
                </button>
            </div>
        </div>

        <!-- Results Display -->
        <h2 class="text-2xl font-bold text-gray-200 mb-6">
            Semantic Search Results 
            <span id="resultCount" class="ml-3 text-lg font-normal text-gray-400"></span>
        </h2>
        
        <!-- Geographic Heatmap for Search Results -->
        <div id="search-results-heatmap" class="mb-6" style="display: none;">
            <div class="card p-6">
                <h3 class="text-xl font-semibold text-gray-300 mb-4">Geographic Distribution of Search Results</h3>
                <p class="text-sm text-gray-400 mb-4">Heatmap showing where the matching experiences are located across the United States.</p>
                <div id="search-heatmap-container" class="w-full" style="min-height: 500px;"></div>
            </div>
        </div>
        
        <div id="results" class="card p-6 min-h-[200px] w-full mb-12">
            <p class="text-gray-500 text-center">Click "Search Experiences" to view results.</p>
        </div>

        <!-- Visualizations Section -->
        <div class="mt-12 border-t border-gray-600 pt-8">
            <h2 class="text-2xl font-bold text-gray-200 mb-6">ðŸ“Š Data Visualizations</h2>
            <p class="text-sm text-gray-400 mb-6">Generate interactive visualizations to analyze patterns, clusters, and correlations in client experiences.</p>
            <div class="bg-blue-900 border border-blue-700 p-4 mb-6 rounded">
                <p class="text-sm text-blue-200">
                    <strong>Note:</strong> These visualizations are based on the current dataset in the database. 
                    The accuracy and meaningfulness of the visualizations depend on the diversity and completeness of the data. 
                    With the current sample size and limited policy metadata fields populated, some visualizations may show 
                    limited variation. As more diverse data with complete policy metadata (service office locations, program 
                    enrollments, varied stability measures) is added, the visualizations will become more informative and 
                    actionable for policy analysis.
                </p>
            </div>
            
            <!-- t-SNE Clustering -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-300 mb-4">1. Conceptual Vector Clustering (t-SNE)</h3>
                <p class="text-sm text-gray-400 mb-4">Maps 512-dimensional vector space to 2D, showing conceptual relationships between experiences. Identifies clusters and outliers.</p>
                <p class="text-xs text-gray-500 mb-4 italic">Note: This visualization works well with current data as it uses semantic vectors. Clustering quality improves with more diverse experiences.</p>
                <button onclick="loadTSNEVisualization()" class="btn-primary px-4 py-2 mb-4">Generate Clustering Visualization</button>
                <div id="tsne-container" class="w-full" style="min-height: 500px;"></div>
            </div>

            <!-- Geospatial Heatmap -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-300 mb-4">2. Barrier Friction Map (Geospatial Analysis)</h3>
                <p class="text-sm text-gray-400 mb-4">Shows geographic distribution of barriers by service office location and urban/rural designation.</p>
                <p class="text-xs text-gray-500 mb-4 italic">Note: Requires populated service_office_location and diverse urban_rural_designation fields. Currently limited by sample data defaults.</p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Issue Category:</label>
                    <select id="geoTagFilter" class="input-field w-full md:w-64 p-2">
                        <option value="">All Issues</option>
                        <option value="Cognitive Load">Cognitive Load / Administrative Overwhelm</option>
                        <option value="Dignity Deprivation">Dignity Deprivation / Stigma</option>
                        <option value="Systemic Frustration">Systemic Frustration / Bureaucracy</option>
                        <option value="Housing Insecurity">Housing Insecurity / Eviction Risk</option>
                        <option value="Time Poverty">Time Poverty / Scheduling Barriers</option>
                        <option value="Financial Stress">Financial Stress / Economic Hardship</option>
                        <option value="Social Isolation">Social Isolation / Lack of Support</option>
                        <option value="Healthcare Barrier">Healthcare Access Barriers</option>
                        <option value="Community Support">Community Support / Social Capital</option>
                    </select>
                </div>
                <button onclick="loadGeospatialVisualization()" class="btn-primary px-4 py-2 mb-4">Generate Geospatial Map</button>
                <div id="geospatial-container" class="w-full"></div>
            </div>

            <!-- Geographic Map -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-300 mb-4">3. Geographic Issue Heatmap (US Map)</h3>
                <p class="text-sm text-gray-400 mb-4">Visualize where specific client experience issues are occurring across the United States. Shows state-level heatmap intensity based on issue frequency and severity.</p>
                <p class="text-xs text-gray-500 mb-4 italic">Note: Requires populated city and state fields in the data. Currently limited by sample data defaults.</p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Issue Category:</label>
                    <select id="geoMapTagFilter" class="input-field w-full md:w-64 p-2">
                        <option value="">All Issues</option>
                        <option value="Cognitive Load">Cognitive Load / Administrative Overwhelm</option>
                        <option value="Dignity Deprivation">Dignity Deprivation / Stigma</option>
                        <option value="Systemic Frustration">Systemic Frustration / Bureaucracy</option>
                        <option value="Housing Insecurity">Housing Insecurity / Eviction Risk</option>
                        <option value="Time Poverty">Time Poverty / Scheduling Barriers</option>
                        <option value="Financial Stress">Financial Stress / Economic Hardship</option>
                        <option value="Social Isolation">Social Isolation / Lack of Support</option>
                        <option value="Anxiety">Anxiety / Mental Health Stress</option>
                        <option value="Healthcare Barrier">Healthcare Access Barriers</option>
                        <option value="Community Support">Community Support / Social Capital</option>
                    </select>
                </div>
                <button onclick="loadGeographicMap()" class="btn-primary px-4 py-2 mb-4">Generate Geographic Map</button>
                <div id="geographic-map-container" class="w-full" style="min-height: 600px;"></div>
            </div>

            <!-- Correlation Plot -->
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-300 mb-4">4. Subjective vs. Objective Correlation Plot</h3>
                <p class="text-sm text-gray-400 mb-4">Compare subjective ratings (anxiety, control, hope) against objective stability measures (residential moves, financial volatility).</p>
                <p class="text-xs text-gray-500 mb-4 italic">Note: Requires varied values in both subjective and objective measures. Currently limited by sample data having mostly default values (e.g., all moves=0, limited anxiety variation).</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">X-Axis (Subjective):</label>
                        <select id="corrXAxis" class="input-field w-full p-2">
                            <option value="survey_anxiety">Survey Anxiety (1-5)</option>
                            <option value="survey_control">Survey Control (1-5)</option>
                            <option value="survey_hope">Survey Hope (1-5)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Y-Axis (Objective):</label>
                        <select id="corrYAxis" class="input-field w-full p-2">
                            <option value="residential_moves_count">Residential Moves (Last 12 Mos)</option>
                            <option value="financial_volatility_index">Financial Volatility Index</option>
                        </select>
                    </div>
                </div>
                <button onclick="loadCorrelationVisualization()" class="btn-primary px-4 py-2 mb-4">Generate Correlation Plot</button>
                <div id="correlation-container" class="w-full" style="min-height: 500px;"></div>
            </div>
        </div>
    </div>

    <!-- Plotly.js for visualizations -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <script>
        // Check connection status on load
        async function checkConnection() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.connected) {
                    document.getElementById('connectionStatus').textContent = 
                        `âœ“ Connected`;
                    document.getElementById('connectionStatus').className = 'text-green-400 font-semibold';
                    
                    if (data.has_data && data.total_objects > 0) {
                        document.getElementById('dataStatus').textContent = 
                            `| ${data.total_objects} experience${data.total_objects !== 1 ? 's' : ''} in database`;
                        document.getElementById('dataStatus').className = 'text-green-400';
                    } else {
                        document.getElementById('dataStatus').textContent = 
                            '| âš  No data found. Run: python -B ingest_data.py';
                        document.getElementById('dataStatus').className = 'text-yellow-400 font-semibold';
                    }
                } else {
                    document.getElementById('connectionStatus').textContent = 
                        'âš  Database connection issue';
                    document.getElementById('connectionStatus').className = 'text-yellow-400';
                    if (data.error) {
                        document.getElementById('dataStatus').textContent = `| Error: ${data.error}`;
                        document.getElementById('dataStatus').className = 'text-red-400';
                    }
                }
            } catch (error) {
                document.getElementById('connectionStatus').textContent = 
                    'âœ— Cannot connect to server. Make sure Flask server is running.';
                document.getElementById('connectionStatus').className = 'text-red-400';
                document.getElementById('dataStatus').textContent = '';
            }
        }

        async function handleSearch() {
            const queryText = document.getElementById('queryInput').value.trim();
            const excludeText = document.getElementById('excludeInput').value.trim();
            const filterReligiosity = document.getElementById('filterReligiosity').value;
            const filterAnxiety = document.getElementById('filterAnxiety').value;
            const filterAnxietyMin = document.getElementById('filterAnxietyMin').value || null;
            const filterAnxietyMax = document.getElementById('filterAnxietyMax').value || null;
            const filterProgram = document.getElementById('filterProgram').value;
            const filterEnrollmentStatus = document.getElementById('filterEnrollmentStatus').value;
            const filterUrbanRural = document.getElementById('filterUrbanRural').value;
            const filterTimeOfDay = document.getElementById('filterTimeOfDay').value;
            const filterLanguage = document.getElementById('filterLanguage').value;
            const filterMovesMin = document.getElementById('filterMovesMin').value || null;
            const filterMovesMax = document.getElementById('filterMovesMax').value || null;
            
            if (!queryText) {
                const resultsDiv = document.getElementById('results');
                resultsDiv.classList.remove('has-content');
                resultsDiv.classList.add('empty-state');
                resultsDiv.innerHTML = 
                    '<div class="bg-red-900 border border-red-700 p-6 text-center w-full">' +
                    '<p class="text-red-200 font-semibold">Please enter a semantic search query.</p>' +
                    '</div>';
                return;
            }

            const searchButton = document.getElementById('searchButton');
            const originalText = searchButton.innerHTML;
            searchButton.innerHTML = 'Searching...';
            searchButton.disabled = true;
            searchButton.classList.add('opacity-75', 'cursor-not-allowed');
            
            try {
                const includeNLM = document.getElementById('includeNLM').checked;
                
                const includeSAMHSA = document.getElementById('includeSAMHSA').checked;
                const samhsaMetric = document.getElementById('samhsaMetric').value;
                
                const requestBody = {
                    query: queryText,
                    excludeQuery: excludeText,
                    filterReligiosity: filterReligiosity,
                    filterAnxiety: filterAnxiety,
                    filterAnxietyMin: filterAnxietyMin ? parseInt(filterAnxietyMin) : null,
                    filterAnxietyMax: filterAnxietyMax ? parseInt(filterAnxietyMax) : null,
                    filterProgram: filterProgram,
                    filterEnrollmentStatus: filterEnrollmentStatus,
                    filterUrbanRural: filterUrbanRural,
                    filterTimeOfDay: filterTimeOfDay,
                    filterLanguage: filterLanguage,
                    filterMovesMin: filterMovesMin ? parseInt(filterMovesMin) : null,
                    filterMovesMax: filterMovesMax ? parseInt(filterMovesMax) : null,
                    includeNLM: includeNLM,
                    includeSAMHSA: includeSAMHSA,
                    samhsaMetric: samhsaMetric,
                    limit: 5
                };

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.results && data.results.length > 0) {
                    displayResults(data.results);
                    // Display geographic heatmap based on search results
                    if (data.geographic_distribution && data.geographic_distribution.total_locations > 0) {
                        displayGeographicHeatmap(data.geographic_distribution);
                    }
                    document.getElementById('resultCount').textContent = 
                        `(${data.count} result${data.count !== 1 ? 's' : ''})`;
                } else {
                    displayNoResults(data.query, data.filters_applied);
                    document.getElementById('resultCount').textContent = '(No results)';
                    // Hide heatmap if no results
                    const heatmapContainer = document.getElementById('search-results-heatmap');
                    if (heatmapContainer) {
                        heatmapContainer.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Search error:', error);
                const resultsDiv = document.getElementById('results');
                resultsDiv.classList.remove('has-content');
                resultsDiv.classList.add('empty-state');
                resultsDiv.innerHTML = 
                    '<div class="bg-red-900 border border-red-700 p-6 text-center w-full">' +
                    '<p class="text-red-200 font-semibold">Error performing search.</p>' +
                    '<p class="text-red-300 text-sm mt-2">' + error.message + '</p>' +
                    '</div>';
                document.getElementById('resultCount').textContent = '';
            } finally {
                searchButton.innerHTML = originalText;
                searchButton.disabled = false;
                searchButton.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        function displayNoResults(query, filters) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('has-content');
            resultsDiv.classList.add('empty-state');
            
            let filterInfo = '';
            if (filters) {
                const activeFilters = [];
                if (filters.religiosity && filters.religiosity !== 'ALL') {
                    activeFilters.push(`Religiosity: ${filters.religiosity}`);
                }
                if (filters.anxiety && filters.anxiety !== 'ALL') {
                    activeFilters.push(`Anxiety: ${filters.anxiety}`);
                }
                if (activeFilters.length > 0) {
                    filterInfo = '<p class="text-yellow-300 text-sm mt-2">Active filters: ' + activeFilters.join(', ') + '</p>';
                }
            }
            
            resultsDiv.innerHTML = 
                '<div class="bg-yellow-900 border border-yellow-700 p-8 text-center w-full box-border">' +
                '<p class="text-yellow-200 font-semibold text-lg mb-2">No experiences matched your query.</p>' +
                '<p class="text-yellow-300 text-sm mb-4">Query: "' + query + '"</p>' +
                filterInfo +
                '<div class="mt-4 text-sm text-yellow-300">' +
                '<p class="font-semibold mb-2">Suggestions:</p>' +
                '<ul class="list-disc list-inside text-left max-w-md mx-auto space-y-1">' +
                '<li>Try a broader query (e.g., "hope", "struggle", "community")</li>' +
                '<li>Remove or adjust filters</li>' +
                '<li>Check if data has been ingested: <code class="bg-yellow-800 px-2 py-1">python -B ingest_data.py</code></li>' +
                '</ul>' +
                '</div>' +
                '</div>';
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('empty-state');
            resultsDiv.classList.add('has-content');
            
            if (results.length === 0) {
                displayNoResults('', {});
                return;
            }

            results.forEach((match, index) => {
                const metadata = match.metadata;
                const scorePercent = ((match.score) * 100).toFixed(1);
                const anxiety = metadata.survey_anxiety !== null && metadata.survey_anxiety !== undefined 
                    ? `${metadata.survey_anxiety}/5` : 'N/A';
                const control = metadata.survey_control !== null && metadata.survey_control !== undefined 
                    ? `${metadata.survey_control}/5` : 'N/A';
                const hope = metadata.survey_hope !== null && metadata.survey_hope !== undefined 
                    ? `${metadata.survey_hope}/5` : 'N/A';
                const volatility = metadata.time_series_volatility !== null && metadata.time_series_volatility !== undefined 
                    ? `${metadata.time_series_volatility}/5` : 'N/A';
                const program = metadata.current_program_enrollment || 'N/A';
                const enrollmentStatus = metadata.enrollment_status_change || 'N/A';
                const urbanRural = metadata.urban_rural_designation || 'N/A';
                const timeOfDay = metadata.incident_time_of_day || 'N/A';
                const language = metadata.primary_language || 'N/A';
                const moves = metadata.residential_moves_count !== null && metadata.residential_moves_count !== undefined 
                    ? metadata.residential_moves_count : 'N/A';
                
                // NLM Enrichment Section
                let nlmSection = '';
                if (metadata.nlm_enrichment) {
                    const nlm = metadata.nlm_enrichment;
                    nlmSection = `
                        <div class="mt-4 pt-4 border-t border-gray-600">
                            <h4 class="text-sm font-semibold text-blue-400 mb-2">ðŸ“š Health Information from National Library of Medicine</h4>
                            ${nlm.health_keywords && nlm.health_keywords.length > 0 ? 
                                `<p class="text-xs text-gray-400 mb-2"><strong>Health Topics:</strong> ${nlm.health_keywords.join(', ')}</p>` : ''}
                            
                            ${nlm.medlineplus_articles && nlm.medlineplus_articles.length > 0 ? `
                                <div class="mb-3">
                                    <p class="text-xs font-semibold text-gray-300 mb-1">MedlinePlus Articles:</p>
                                    ${nlm.medlineplus_articles.map(article => `
                                        <a href="${article.url}" target="_blank" 
                                           class="block text-xs text-blue-400 hover:text-blue-300 hover:underline mb-1">
                                            â€¢ ${article.title}
                                        </a>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${nlm.pubmed_articles && nlm.pubmed_articles.length > 0 ? `
                                <div class="mb-3">
                                    <p class="text-xs font-semibold text-gray-300 mb-1">Research Articles (PubMed):</p>
                                    ${nlm.pubmed_articles.map(article => `
                                        <a href="${article.url}" target="_blank" 
                                           class="block text-xs text-blue-400 hover:text-blue-300 hover:underline mb-1">
                                            â€¢ ${article.title}
                                        </a>
                                        ${article.authors ? `<span class="text-xs text-gray-500 ml-2">by ${article.authors}</span>` : ''}
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Create a title from the text snippet (first 80 characters or first sentence)
                const textSnippet = metadata.text_snippet || 'N/A';
                let resultTitle = textSnippet;
                if (textSnippet.length > 80) {
                    // Try to find the first sentence
                    const firstSentence = textSnippet.match(/^[^.!?]+[.!?]/);
                    if (firstSentence) {
                        resultTitle = firstSentence[0].trim();
                    } else {
                        // Otherwise truncate at 80 chars with ellipsis
                        resultTitle = textSnippet.substring(0, 77) + '...';
                    }
                }
                
                // Format the category tag (tag_abstract)
                const categoryTag = metadata.subjective_concept || 'Uncategorized';
                const categoryParts = categoryTag.split('/');
                const primaryCategory = categoryParts[0];
                const secondaryCategory = categoryParts.length > 1 ? categoryParts[1] : null;

                const resultCard = `
                    <div class="result-card p-5 mb-4 box-border">
                        <div class="flex items-start justify-between mb-3 pb-3 border-b border-gray-600">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sm font-bold text-gray-400">#${index + 1}</span>
                                    <span class="text-xs font-semibold text-blue-400 bg-blue-900 px-2 py-1">${primaryCategory}</span>
                                    ${secondaryCategory ? `<span class="text-xs font-semibold text-blue-300 bg-blue-800 px-2 py-1">${secondaryCategory}</span>` : ''}
                                </div>
                                <h3 class="text-base font-semibold text-gray-200 leading-snug">${resultTitle}</h3>
                            </div>
                            <span class="text-xs font-semibold text-green-400 bg-green-900 px-2 py-1 ml-3 flex-shrink-0">${scorePercent}% Match</span>
                        </div>
                        <p class="text-gray-400 text-sm mb-3 leading-relaxed break-words pl-2 border-l-2 border-gray-600">"${textSnippet}"</p>
                        <div class="flex flex-wrap justify-start text-sm text-gray-400 gap-4">
                            <span><strong class="text-gray-300">Religiosity:</strong> ${metadata.religious_participation || 'N/A'}</span>
                            <span><strong class="text-gray-300">Anxiety:</strong> ${anxiety}</span>
                            <span><strong class="text-gray-300">Control:</strong> ${control}</span>
                            <span><strong class="text-gray-300">Hope:</strong> ${hope}</span>
                            ${volatility !== 'N/A' ? `<span><strong class="text-gray-300">Volatility:</strong> ${volatility}</span>` : ''}
                            ${metadata.ed_level_primary ? `<span><strong class="text-gray-300">Education:</strong> ${metadata.ed_level_primary}</span>` : ''}
                            ${program !== 'N/A' ? `<span><strong class="text-gray-300">Program:</strong> ${program}</span>` : ''}
                            ${enrollmentStatus !== 'N/A' ? `<span><strong class="text-gray-300">Status:</strong> ${enrollmentStatus}</span>` : ''}
                            ${urbanRural !== 'N/A' ? `<span><strong class="text-gray-300">Location:</strong> ${urbanRural}</span>` : ''}
                            ${timeOfDay !== 'N/A' ? `<span><strong class="text-gray-300">Time:</strong> ${timeOfDay}</span>` : ''}
                            ${language !== 'N/A' ? `<span><strong class="text-gray-300">Language:</strong> ${language}</span>` : ''}
                            ${moves !== 'N/A' ? `<span><strong class="text-gray-300">Moves:</strong> ${moves}</span>` : ''}
                        </div>
                        ${nlmSection}
                    </div>
                `;
                resultsDiv.innerHTML += resultCard;
            });
        }

        // Visualization Functions
        async function loadTSNEVisualization() {
            const container = document.getElementById('tsne-container');
            container.innerHTML = '<p class="text-gray-400">Loading visualization...</p>';
            
            try {
                const response = await fetch('/api/visualizations/tsne');
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<p class="text-red-400">Error: ${data.error}</p>`;
                    return;
                }
                
                // Group points by tag_abstract for color coding
                const tagGroups = {};
                data.points.forEach(point => {
                    const tag = point.tag_abstract || 'Uncategorized';
                    if (!tagGroups[tag]) {
                        tagGroups[tag] = {x: [], y: [], text: [], ids: []};
                    }
                    tagGroups[tag].x.push(point.x);
                    tagGroups[tag].y.push(point.y);
                    tagGroups[tag].text.push(`${point.text_snippet}<br>Tag: ${point.tag_abstract}<br>Program: ${point.program}`);
                    tagGroups[tag].ids.push(point.id);
                });
                
                const traces = Object.keys(tagGroups).map(tag => ({
                    x: tagGroups[tag].x,
                    y: tagGroups[tag].y,
                    text: tagGroups[tag].text,
                    mode: 'markers',
                    type: 'scatter',
                    name: tag,
                    hovertemplate: '%{text}<extra></extra>',
                    marker: {size: 8}
                }));
                
                const layout = {
                    title: 'Conceptual Vector Clustering (t-SNE)',
                    xaxis: {title: 't-SNE Dimension 1'},
                    yaxis: {title: 't-SNE Dimension 2'},
                    hovermode: 'closest',
                    plot_bgcolor: '#1a1a1a',
                    paper_bgcolor: '#2d2d2d',
                    font: {color: '#e5e5e5'},
                    showlegend: true
                };
                
                Plotly.newPlot('tsne-container', traces, layout, {responsive: true});
            } catch (error) {
                container.innerHTML = `<p class="text-red-400">Error loading visualization: ${error.message}</p>`;
            }
        }

        async function loadGeospatialVisualization() {
            const container = document.getElementById('geospatial-container');
            container.innerHTML = '<p class="text-gray-400">Loading visualization...</p>';
            
            try {
                const tagFilter = document.getElementById('geoTagFilter').value;
                const url = `/api/visualizations/geospatial${tagFilter ? '?tag=' + encodeURIComponent(tagFilter) : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<p class="text-red-400">Error: ${data.error}</p>`;
                    return;
                }
                
                // Create a table/chart of location data
                let html = '<div class="overflow-x-auto"><table class="w-full text-sm text-gray-300"><thead><tr class="border-b border-gray-600"><th class="p-2 text-left">Location</th><th class="p-2 text-left">Count</th><th class="p-2 text-left">Urban/Rural</th><th class="p-2 text-left">Top Categories</th></tr></thead><tbody>';
                
                const locations = Object.entries(data.locations).sort((a, b) => b[1].count - a[1].count);
                locations.forEach(([location, info]) => {
                    const topTags = Object.entries(info.tags).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    html += `<tr class="border-b border-gray-700"><td class="p-2">${location}</td><td class="p-2">${info.count}</td><td class="p-2">${info.urban_rural}</td><td class="p-2">${topTags.map(([tag, count]) => `${tag} (${count})`).join(', ')}</td></tr>`;
                });
                
                html += '</tbody></table></div>';
                
                // Add urban/rural breakdown
                html += '<div class="mt-4"><h4 class="text-gray-300 font-semibold mb-2">Urban/Rural Breakdown:</h4><div class="flex gap-4">';
                Object.entries(data.urban_rural_breakdown).forEach(([area, count]) => {
                    const percentage = ((count / data.total_experiences) * 100).toFixed(1);
                    html += `<div class="text-sm"><span class="text-gray-400">${area}:</span> <span class="text-blue-400 font-semibold">${count} (${percentage}%)</span></div>`;
                });
                html += '</div></div>';
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p class="text-red-400">Error loading visualization: ${error.message}</p>`;
            }
        }

        async function loadCorrelationVisualization() {
            const container = document.getElementById('correlation-container');
            container.innerHTML = '<p class="text-gray-400">Loading visualization...</p>';
            
            try {
                const xAxis = document.getElementById('corrXAxis').value;
                const yAxis = document.getElementById('corrYAxis').value;
                const url = `/api/visualizations/correlation?x_axis=${encodeURIComponent(xAxis)}&y_axis=${encodeURIComponent(yAxis)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<p class="text-red-400">Error: ${data.error}</p>`;
                    return;
                }
                
                // Group by tag_abstract for color coding
                const tagGroups = {};
                data.points.forEach(point => {
                    const tag = point.tag_abstract || 'Uncategorized';
                    if (!tagGroups[tag]) {
                        tagGroups[tag] = {x: [], y: [], text: []};
                    }
                    tagGroups[tag].x.push(point.x);
                    tagGroups[tag].y.push(point.y);
                    tagGroups[tag].text.push(`${point.text_snippet}<br>Tag: ${point.tag_abstract}<br>Program: ${point.program}`);
                });
                
                const traces = Object.keys(tagGroups).map(tag => ({
                    x: tagGroups[tag].x,
                    y: tagGroups[tag].y,
                    text: tagGroups[tag].text,
                    mode: 'markers',
                    type: 'scatter',
                    name: tag,
                    hovertemplate: '%{text}<extra></extra>',
                    marker: {size: 10}
                }));
                
                const xLabel = data.x_axis.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                const yLabel = data.y_axis.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                const layout = {
                    title: `${xLabel} vs. ${yLabel}`,
                    xaxis: {title: xLabel},
                    yaxis: {title: yLabel},
                    hovermode: 'closest',
                    plot_bgcolor: '#1a1a1a',
                    paper_bgcolor: '#2d2d2d',
                    font: {color: '#e5e5e5'},
                    showlegend: true
                };
                
                Plotly.newPlot('correlation-container', traces, layout, {responsive: true});
            } catch (error) {
                container.innerHTML = `<p class="text-red-400">Error loading visualization: ${error.message}</p>`;
            }
        }

        async function loadGeographicMap() {
            const container = document.getElementById('geographic-map-container');
            container.innerHTML = '<p class="text-gray-400">Loading geographic map...</p>';
            
            try {
                const tagFilter = document.getElementById('geoMapTagFilter').value;
                const url = `/api/visualizations/geographic${tagFilter ? '?tag=' + encodeURIComponent(tagFilter) : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<p class="text-red-400">Error: ${data.error}</p>`;
                    return;
                }
                
                if (data.locations_with_data === 0) {
                    container.innerHTML = `
                        <div class="bg-yellow-900 border border-yellow-700 p-6 text-center">
                            <p class="text-yellow-200">No geographic data available.</p>
                            <p class="text-yellow-300 text-sm mt-2">The current dataset does not have city/state information populated. Add city and state fields to your CSV data to enable this visualization.</p>
                        </div>
                    `;
                    return;
                }
                
                // Prepare data for Plotly scattergeo map
                const locations = Object.values(data.locations);
                const lats = [];
                const lons = [];
                const texts = [];
                const sizes = [];
                const colors = [];
                
                // State abbreviation mapping (for geocoding)
                const stateAbbrev = {
                    'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                    'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                    'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                    'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                    'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                    'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                    'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                    'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                    'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                    'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
                };
                
                // Aggregate by state with issue category scoring
                const stateData = {};
                Object.entries(data.state_counts).forEach(([state, stateInfo]) => {
                    const stateKey = stateAbbrev[state] || state;
                    stateData[stateKey] = {
                        count: stateInfo.count || 0,
                        cities: [],
                        tags: stateInfo.tags || {},
                        issue_scores: stateInfo.issue_scores || {},
                        avg_anxiety: stateInfo.avg_anxiety,
                        avg_control: stateInfo.avg_control,
                        avg_hope: stateInfo.avg_hope
                    };
                });
                
                // Add city info from locations
                Object.values(data.locations).forEach(loc => {
                    const state = loc.state;
                    const stateKey = stateAbbrev[state] || state;
                    if (stateData[stateKey]) {
                        if (!stateData[stateKey].cities.includes(loc.city)) {
                            stateData[stateKey].cities.push(loc.city);
                        }
                    }
                });
                
                const stateCodes = Object.keys(stateData);
                
                // Determine which issue to display based on filter or highest score
                let displayIssue = tagFilter || '';
                let stateValues, colorbarTitle, colorscale;
                
                if (displayIssue && stateCodes.length > 0) {
                    // Show selected issue category
                    stateValues = stateCodes.map(code => {
                        return stateData[code].issue_scores[displayIssue] || 0;
                    });
                    colorbarTitle = `${displayIssue} Intensity Score`;
                    colorscale = 'Reds';
                } else {
                    // Show total count or highest issue score
                    const allIssues = data.issue_categories || [];
                    if (allIssues.length > 0) {
                        // Find the issue with highest average score across all states
                        let maxAvgScore = 0;
                        let topIssue = null;
                        for (const issue of allIssues) {
                            const avgScore = stateCodes.reduce((sum, code) => {
                                return sum + (stateData[code].issue_scores[issue] || 0);
                            }, 0) / stateCodes.length;
                            if (avgScore > maxAvgScore) {
                                maxAvgScore = avgScore;
                                topIssue = issue;
                            }
                        }
                        
                        if (topIssue && maxAvgScore > 0) {
                            displayIssue = topIssue;
                            stateValues = stateCodes.map(code => {
                                return stateData[code].issue_scores[topIssue] || 0;
                            });
                            colorbarTitle = `${topIssue} Intensity Score`;
                            colorscale = 'Reds';
                        } else {
                            // Fallback to count
                            stateValues = stateCodes.map(code => stateData[code].count);
                            colorbarTitle = 'Number of Experiences';
                            colorscale = 'Blues';
                        }
                    } else {
                        // Fallback to count
                        stateValues = stateCodes.map(code => stateData[code].count);
                        colorbarTitle = 'Number of Experiences';
                        colorscale = 'Blues';
                    }
                }
                
                const stateTexts = stateCodes.map(code => {
                    const data = stateData[code];
                    const topTags = Object.entries(data.tags).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    const topIssues = Object.entries(data.issue_scores)
                        .filter(([_, score]) => score > 0)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3);
                    
                    let info = `${code}<br>Experiences: ${data.count}<br>Cities: ${data.cities.join(', ')}`;
                    
                    if (topIssues.length > 0) {
                        info += `<br>Top Issues: ${topIssues.map(([issue, score]) => `${issue} (${score})`).join(', ')}`;
                    } else if (topTags.length > 0) {
                        info += `<br>Top Tags: ${topTags.map(([t, c]) => `${t} (${c})`).join(', ')}`;
                    }
                    
                    if (data.avg_anxiety !== undefined && data.avg_anxiety !== null) {
                        info += `<br>Avg Anxiety: ${data.avg_anxiety.toFixed(1)}/5`;
                    }
                    
                    if (displayIssue && data.issue_scores[displayIssue] > 0) {
                        info += `<br><strong>${displayIssue} Score: ${data.issue_scores[displayIssue]}</strong>`;
                    }
                    
                    return info;
                });
                
                const trace = {
                    type: 'choropleth',
                    locationmode: 'USA-states',
                    locations: stateCodes,
                    z: stateValues,
                    text: stateTexts,
                    colorscale: 'Reds',
                    colorbar: {
                        title: 'Number of Experiences',
                        titlefont: {color: '#e5e5e5'},
                        tickfont: {color: '#e5e5e5'}
                    },
                    hovertemplate: '%{text}<extra></extra>',
                    marker: {
                        line: {
                            color: '#2d2d2d',
                            width: 1
                        }
                    }
                };
                
                const layout = {
                    title: {
                        text: displayIssue 
                            ? `Geographic Distribution: ${displayIssue}`
                            : 'Geographic Distribution of Client Experiences',
                        font: {color: '#e5e5e5', size: 18}
                    },
                    geo: {
                        scope: 'usa',
                        bgcolor: '#1a1a1a',
                        showlakes: true,
                        lakecolor: '#2d2d2d',
                        showland: true,
                        landcolor: '#2d2d2d',
                        showcoastlines: true,
                        coastlinecolor: '#3a3a3a',
                        projection: {
                            type: 'albers usa'
                        },
                        lonaxis: {},
                        lataxis: {}
                    },
                    paper_bgcolor: '#2d2d2d',
                    plot_bgcolor: '#1a1a1a',
                    font: {color: '#e5e5e5'}
                };
                
                Plotly.newPlot('geographic-map-container', [trace], layout, {responsive: true});
                
            } catch (error) {
                container.innerHTML = `<p class="text-red-400">Error loading geographic map: ${error.message}</p>`;
            }
        }

        function displayGeographicHeatmap(geoData) {
            const container = document.getElementById('search-results-heatmap');
            const mapContainer = document.getElementById('search-heatmap-container');
            
            if (!geoData || geoData.total_locations === 0) {
                if (container) container.style.display = 'none';
                return;
            }
            
            if (container) container.style.display = 'block';
            if (mapContainer) mapContainer.innerHTML = '<p class="text-gray-400">Loading heatmap...</p>';
            
            try {
                // State abbreviation mapping
                const stateAbbrev = {
                    'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                    'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                    'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                    'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                    'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                    'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                    'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                    'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                    'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                    'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
                };
                
                // Category display names
                const categoryNames = {
                    'depression': 'Depression/Hopelessness',
                    'anxiety': 'Anxiety/Stress',
                    'social_isolation': 'Social Isolation',
                    'dignity_deprivation': 'Dignity Deprivation',
                    'cognitive_load': 'Cognitive Load',
                    'housing_insecurity': 'Housing Insecurity',
                    'financial_stress': 'Financial Stress',
                    'time_poverty': 'Time Poverty',
                    'systemic_frustration': 'Systemic Frustration'
                };
                
                // Determine which metric to display
                let displayMetric = 'count';
                let metricTitle = 'Number of Results';
                let primaryCategory = null;
                
                // Check if we have primary categories from backend
                if (geoData.primary_categories && geoData.primary_categories.length > 0) {
                    primaryCategory = geoData.primary_categories[0];
                    displayMetric = 'category';
                    metricTitle = categoryNames[primaryCategory] || primaryCategory.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
                // Check if we have survey anxiety data
                else if (geoData.state_counts) {
                    const statesWithAnxiety = Object.values(geoData.state_counts).filter(s => s.avg_anxiety !== undefined);
                    if (statesWithAnxiety.length > 0) {
                        displayMetric = 'anxiety';
                        metricTitle = 'Average Anxiety Level (1-5)';
                    }
                }
                
                // Aggregate by state
                const stateData = {};
                Object.entries(geoData.state_counts).forEach(([state, data]) => {
                    const stateKey = stateAbbrev[state] || state;
                    stateData[stateKey] = {
                        count: data.count || 0,
                        cities: [],
                        tags: {},
                        category_scores: data.category_scores || {},
                        avg_anxiety: data.avg_anxiety,
                        avg_control: data.avg_control,
                        avg_hope: data.avg_hope
                    };
                });
                
                // Add city info from locations
                Object.values(geoData.locations).forEach(loc => {
                    const state = loc.state;
                    const stateKey = stateAbbrev[state] || state;
                    if (stateData[stateKey]) {
                        if (!stateData[stateKey].cities.includes(loc.city)) {
                            stateData[stateKey].cities.push(loc.city);
                        }
                        Object.entries(loc.tags).forEach(([tag, count]) => {
                            stateData[stateKey].tags[tag] = (stateData[stateKey].tags[tag] || 0) + count;
                        });
                    }
                });
                
                const stateCodes = Object.keys(stateData);
                
                // Check if SAMHSA data is available
                const hasSAMHSA = geoData.samhsa_data && geoData.samhsa_data.state_samhsa_data;
                let showSAMHSA = false;
                
                // Determine values based on selected metric
                let stateValues, colorbarTitle, colorscale;
                if (hasSAMHSA && displayMetric !== 'anxiety') {
                    // Show SAMHSA prevalence data when available
                    showSAMHSA = true;
                    stateValues = stateCodes.map(code => {
                        return geoData.samhsa_data.state_samhsa_data[code] || 0;
                    });
                    const metricName = geoData.samhsa_data.metric_used === 'SMI' 
                        ? 'Serious Mental Illness' 
                        : 'Any Mental Illness';
                    colorbarTitle = `SAMHSA ${metricName} Prevalence (%)`;
                    colorscale = 'YlOrRd'; // Yellow-Orange-Red for prevalence
                } else if (displayMetric === 'category' && primaryCategory) {
                    stateValues = stateCodes.map(code => {
                        const score = stateData[code].category_scores[primaryCategory] || 0;
                        return score;
                    });
                    colorbarTitle = categoryNames[primaryCategory] || primaryCategory;
                    colorscale = 'Reds';
                } else if (displayMetric === 'anxiety') {
                    stateValues = stateCodes.map(code => {
                        return stateData[code].avg_anxiety || 0;
                    });
                    colorbarTitle = 'Average Anxiety (1-5)';
                    colorscale = 'OrRd'; // Orange-Red for anxiety
                } else {
                    // Default to count
                    stateValues = stateCodes.map(code => stateData[code].count);
                    colorbarTitle = 'Number of Results';
                    colorscale = 'Blues';
                }
                
                const stateTexts = stateCodes.map(code => {
                    const data = stateData[code];
                    const topTags = Object.entries(data.tags).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    let info = `${code}<br>Experiences: ${data.count}<br>Cities: ${data.cities.join(', ')}`;
                    
                    if (topTags.length > 0) {
                        info += `<br>Top Issues: ${topTags.map(([t, c]) => `${t} (${c})`).join(', ')}`;
                    }
                    
                    if (data.avg_anxiety !== undefined) {
                        info += `<br>Avg Anxiety: ${data.avg_anxiety.toFixed(1)}/5`;
                    }
                    
                    if (primaryCategory && data.category_scores[primaryCategory]) {
                        const catName = categoryNames[primaryCategory] || primaryCategory;
                        info += `<br>${catName} Score: ${data.category_scores[primaryCategory]}`;
                    }
                    
                    // Add SAMHSA data if available
                    if (hasSAMHSA && geoData.samhsa_data.state_samhsa_data[code]) {
                        const samhsaValue = geoData.samhsa_data.state_samhsa_data[code];
                        const metricName = geoData.samhsa_data.metric_used === 'SMI' 
                            ? 'SMI Prevalence' 
                            : 'AMI Prevalence';
                        info += `<br><strong>${metricName}: ${samhsaValue.toFixed(1)}%</strong>`;
                        
                        // Show correlation if available
                        if (geoData.samhsa_data.comparison_data && geoData.samhsa_data.comparison_data[code]) {
                            const comparison = geoData.samhsa_data.comparison_data[code];
                            if (comparison.search_intensity > 0) {
                                info += `<br>Search Intensity: ${comparison.search_intensity.toFixed(1)}`;
                            }
                        }
                    }
                    
                    return info;
                });
                
                const trace = {
                    type: 'choropleth',
                    locationmode: 'USA-states',
                    locations: stateCodes,
                    z: stateValues,
                    text: stateTexts,
                    colorscale: colorscale,
                    colorbar: {
                        title: colorbarTitle,
                        titlefont: {color: '#e5e5e5'},
                        tickfont: {color: '#e5e5e5'}
                    },
                    hovertemplate: '%{text}<extra></extra>',
                    marker: {
                        line: {
                            color: '#2d2d2d',
                            width: 1
                        }
                    }
                };
                
                const layout = {
                    title: {
                        text: showSAMHSA 
                            ? `SAMHSA ${geoData.samhsa_data.metric_used} Prevalence vs Search Results`
                            : `Geographic Distribution: ${metricTitle}`,
                        font: {color: '#e5e5e5', size: 16}
                    },
                    geo: {
                        scope: 'usa',
                        bgcolor: '#1a1a1a',
                        showlakes: true,
                        lakecolor: '#2d2d2d',
                        showland: true,
                        landcolor: '#2d2d2d',
                        showcoastlines: true,
                        coastlinecolor: '#3a3a3a',
                        projection: {
                            type: 'albers usa'
                        }
                    },
                    paper_bgcolor: '#2d2d2d',
                    plot_bgcolor: '#1a1a1a',
                    font: {color: '#e5e5e5'},
                    margin: {l: 0, r: 0, t: 40, b: 0}
                };
                
                Plotly.newPlot('search-heatmap-container', [trace], layout, {responsive: true});
                
            } catch (error) {
                if (mapContainer) {
                    mapContainer.innerHTML = `<p class="text-red-400">Error displaying heatmap: ${error.message}</p>`;
                }
            }
        }

        // Toggle SAMHSA metric select visibility
        document.addEventListener('DOMContentLoaded', function() {
            const samhsaCheckbox = document.getElementById('includeSAMHSA');
            const samhsaMetricSelect = document.getElementById('samhsaMetricSelect');
            
            if (samhsaCheckbox && samhsaMetricSelect) {
                samhsaCheckbox.addEventListener('change', function() {
                    samhsaMetricSelect.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Initialize connection check on load
        window.onload = checkConnection;
    </script>
</body>
</html>
